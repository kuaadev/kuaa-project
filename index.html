<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUAA 99.9 FM - Salt Lake City Community Radio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --kuaa-primary: #E63946;
            --kuaa-secondary: #F1FAEE;
            --kuaa-dark: #1D3557;
            --kuaa-light: #A8DADC;
            --kuaa-accent: #457B9D;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--kuaa-secondary);
            color: var(--kuaa-dark);
        }

        .navbar {
            background-color: rgba(29, 53, 87, 0.95);
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-weight: 900;
            font-size: 1.8rem;
        }

        .nav-link {
            font-weight: 700;
        }

        .btn-danger {
            background-color: var(--kuaa-primary);
            border-color: var(--kuaa-primary);
        }

        .btn-danger:hover {
            background-color: #c42d39;
            border-color: #c42d39;
        }

        .section-title {
            font-weight: 900;
            color: var(--kuaa-dark);
            position: relative;
            display: inline-block;
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50%;
            height: 4px;
            background-color: var(--kuaa-primary);
            border-radius: 2px;
        }

        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7)), url('https://placehold.co/1920x1080/1D3557/F1FAEE?text=KUAA+Broadcast') no-repeat center center;
            background-size: cover;
            color: var(--kuaa-secondary);
            padding: 8rem 0;
        }

        .hero h1 {
            font-weight: 900;
            font-size: 3.5rem;
        }

        .now-playing-card {
            background-color: rgba(29, 53, 87, 0.8);
            border: 2px solid var(--kuaa-light);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(5px);
        }

        .now-playing-card img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #play-pause-btn {
            background-color: var(--kuaa-primary);
            color: var(--kuaa-secondary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2rem;
            line-height: 1;
            border: none;
            transition: all 0.2s ease-in-out;
        }

        #play-pause-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--kuaa-primary);
        }

        .schedule .nav-link {
            color: var(--kuaa-accent);
            font-weight: 700;
        }

        .schedule .nav-link.active {
            background-color: var(--kuaa-accent) !important;
            color: var(--kuaa-secondary) !important;
        }

        .schedule .table {
            border-radius: 0.5rem;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- Hidden Audio Player -->
    <audio id="audio-player" preload="auto">
        <source src="https://stream.xmission.com/kuaa" type="audio/mpeg">
    </audio>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">KUAA 99.9FM</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span
                        class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a class="nav-link" href="#home">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#schedule">Schedule</a></li>
                        <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>
                        <li class="nav-item ms-lg-2 mt-2 mt-lg-0">
                            <button id="nav-play-btn" class="btn btn-danger btn-lg">
                                <i id="nav-play-icon" class="bi bi-play-fill"></i> Listen Live
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <section id="home" class="hero text-center">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <h1 class="display-4 mb-4">Low Powered FM Community Radio Station in Salt Lake City</h1>
                        <p class="lead mb-5">KUAA 99.9 FM is a low powered FM community radio station broadcasting
                            terrestrially in Salt Lake City at 99.9FM, and streaming around the world at kuaafm.org. We
                            pride ourselves on specializing in musical, cultural, linguistic, and artistic diversity.
                            KUAA is an extension of and brought to you by Utah Arts Alliance.</p>

                        <div id="listen-live-player" class="now-playing-card d-flex align-items-center p-3">
                            <img id="now-playing-cover" src="https://placehold.co/120x120/1D3557/F1FAEE?text=KUAA"
                                class="rounded shadow" alt="Album Art">
                            <div class="ms-3 ms-md-4 text-start flex-grow-1">
                                <h3 class="mb-1 small text-uppercase fw-bold">NOW PLAYING</h3>
                                <h4 id="now-playing-show" class="text-light mb-1 fs-5">Loading Show...</h4>
                                <p id="now-playing-dj" class="mb-2 small"><em>Loading DJ...</em></p>
                                <p id="now-playing-song" class="mb-0 fw-bold">Loading Song...</p>
                                <p id="now-playing-artist" class="mb-0 small">Loading Artist...</p>
                            </div>
                            <div class="ms-3 ms-md-4">
                                <button id="play-pause-btn" class="d-flex align-items-center justify-content-center">
                                    <i id="play-pause-icon" class="bi bi-play-fill"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <section id="schedule" class="py-5 bg-light">
            <div class="container">
                <h2 class="section-title text-center">Program Schedule</h2>
                <ul class="nav nav-pills justify-content-center mb-4" id="schedule-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link" id="sunday-tab"
                            data-bs-toggle="tab" data-bs-target="#sunday" type="button" role="tab">Sun</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="monday-tab"
                            data-bs-toggle="tab" data-bs-target="#monday" type="button" role="tab">Mon</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="tuesday-tab"
                            data-bs-toggle="tab" data-bs-target="#tuesday" type="button" role="tab">Tue</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="wednesday-tab"
                            data-bs-toggle="tab" data-bs-target="#wednesday" type="button" role="tab">Wed</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="thursday-tab"
                            data-bs-toggle="tab" data-bs-target="#thursday" type="button" role="tab">Thu</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="friday-tab"
                            data-bs-toggle="tab" data-bs-target="#friday" type="button" role="tab">Fri</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="saturday-tab"
                            data-bs-toggle="tab" data-bs-target="#saturday" type="button" role="tab">Sat</button></li>
                </ul>
                <div class="tab-content" id="schedule-content">
                    <div class="tab-pane fade" id="sunday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade show active" id="monday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tuesday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="wednesday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="thursday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="friday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="saturday" role="tabpanel">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status"><span
                                    class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Other sections like About, Contact would go here -->
    </main>
    <footer class="footer py-4">
        <div class="container text-center">
            <div class="mb-3">
                <a href="#" class="fs-4 mx-2"><i class="bi bi-facebook"></i></a>
                <a href="#" class="fs-4 mx-2"><i class="bi bi-instagram"></i></a>
                <a href="#" class="fs-4 mx-2"><i class="bi bi-twitter-x"></i></a>
            </div>
            <p>&copy; 2025 KUAA 99.9 FM. A project of the <a href="https://utaharts.org/" target="_blank">Utah Arts
                    Alliance</a>.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PLAYER CONTROLS ---
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const navPlayBtn = document.getElementById('nav-play-btn');
            const navPlayIcon = document.getElementById('nav-play-icon');

            function togglePlay() {
                const isPaused = audioPlayer.paused;
                if (isPaused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
                updatePlayIcons(!isPaused);
            }

            function updatePlayIcons(isPlaying) {
                if (isPlaying) {
                    playPauseIcon.classList.remove('bi-play-fill');
                    playPauseIcon.classList.add('bi-pause-fill');
                    navPlayIcon.classList.remove('bi-play-fill');
                    navPlayIcon.classList.add('bi-pause-fill');
                } else {
                    playPauseIcon.classList.remove('bi-pause-fill');
                    playPauseIcon.classList.add('bi-play-fill');
                    navPlayIcon.classList.remove('bi-pause-fill');
                    navPlayIcon.classList.add('bi-play-fill');
                }
            }

            playPauseBtn.addEventListener('click', togglePlay);
            navPlayBtn.addEventListener('click', togglePlay);

            // --- NOW PLAYING ---
            const nowPlayingApiUrl = `/.netlify/functions/get-now-playing`;
            const showElement = document.getElementById('now-playing-show');
            const djElement = document.getElementById('now-playing-dj');
            const songElement = document.getElementById('now-playing-song');
            const artistElement = document.getElementById('now-playing-artist');
            const coverElement = document.getElementById('now-playing-cover');

            const fetchNowPlaying = async () => {
                try {
                    const response = await fetch(nowPlayingApiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data.items && data.items.length > 0) {
                        const latestSpin = data.items[0];

                        // The 'show' object is now included in the spin data
                        const showName = latestSpin.show ? latestSpin.show.title : 'Community Programming';

                        const djName = (latestSpin.show && latestSpin.show.personas && latestSpin.show.personas.length > 0)
                            ? latestSpin.show.personas.map(p => p.name).join(' & ')
                            : 'KUAA';

                        showElement.textContent = showName;
                        djElement.innerHTML = `with <em>${djName}</em>`;
                        songElement.textContent = latestSpin.song || 'Music Variety';
                        artistElement.textContent = latestSpin.artist || 'Various Artists';

                        const imageUrl = latestSpin.image || 'https://placehold.co/120x120/1D3557/F1FAEE?text=KUAA';
                        if (coverElement.src !== imageUrl) {
                            coverElement.src = imageUrl;
                        }

                    } else {
                        showElement.textContent = 'Community Programming';
                        djElement.innerHTML = 'with <em>KUAA</em>';
                        songElement.textContent = 'Music for the People';
                        artistElement.textContent = 'Various Artists';
                        coverElement.src = 'https://placehold.co/120x120/1D3557/F1FAEE?text=KUAA';
                    }
                } catch (error) {
                    console.error("Error fetching Now Playing data:", error);
                    showElement.textContent = 'On Air';
                    djElement.innerHTML = '';
                    songElement.textContent = 'Could not load current song info.';
                    artistElement.textContent = 'Please check back shortly.';
                    coverElement.src = 'https://placehold.co/120x120/1D3557/F1FAEE?text=Error';
                }
            };
            fetchNowPlaying();
            setInterval(fetchNowPlaying, 20000);

            // --- SCHEDULE ---
            const scheduleApiUrl = `/.netlify/functions/get-schedule`;
            const formatTime = (dateStr) => {
                const date = new Date(dateStr);
                let hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours %= 12;
                hours = hours || 12;
                return `${hours}:${minutes < 10 ? '0' + minutes : minutes} ${ampm}`;
            };
            const fetchSchedule = async () => {
                try {
                    const response = await fetch(scheduleApiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const scheduleData = await response.json();
                    const shows = scheduleData.items;

                    const showsByDay = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
                    shows.forEach(show => {
                        const showDate = new Date(show.start);
                        const dayOfWeek = showDate.getUTCDay();
                        showsByDay[dayOfWeek].push(show);
                    });

                    for (const day in showsByDay) {
                        showsByDay[day].sort((a, b) => new Date(a.start) - new Date(b.start));
                    }

                    renderSchedule(showsByDay);

                } catch (error) {
                    console.error("Error fetching schedule:", error);
                }
            };
            const renderSchedule = (showsByDay) => {
                const dayMap = { 0: 'sunday', 1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday', 6: 'saturday' };
                for (const dayIndex in dayMap) {
                    const dayName = dayMap[dayIndex];
                    const container = document.getElementById(dayName);
                    const dayShows = showsByDay[dayIndex];

                    if (!container) continue;

                    if (dayShows.length === 0) {
                        container.innerHTML = '<p class="text-center p-3">No shows scheduled for today.</p>';
                    } else {
                        let tableHTML = `<table class="table table-striped table-hover">
                            <thead class="table-dark"><tr><th>Time</th><th>Show</th><th>DJ/Host</th></tr></thead><tbody>`;
                        dayShows.forEach(show => {
                            const djName = (show.personas && show.personas.length > 0)
                                ? show.personas.map(p => p.name).join(' & ')
                                : 'KUAA';

                            tableHTML += `<tr>
                                <td>${formatTime(show.start)} - ${formatTime(show.end)}</td>
                                <td>${show.title || 'Untitled Show'}</td>
                                <td>${djName}</td>
                            </tr>`;
                        });
                        tableHTML += `</tbody></table>`;
                        container.innerHTML = tableHTML;
                    }
                }
            };
            fetchSchedule();

            // --- Set Today's Tab as Active ---
            const todayIndex = new Date().getDay();
            const dayMap = { 0: 'sunday', 1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday', 6: 'saturday' };
            const todayTab = document.getElementById(`${dayMap[todayIndex]}-tab`);
            if (todayTab) {
                const tab = new bootstrap.Tab(todayTab);
                tab.show();
            }

            // --- SMOOTH SCROLL ---
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    if (this.getAttribute('data-bs-toggle') === 'tab' || this.id === 'nav-play-btn') return;
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
                });
            });
        });
    </script>
</body>

</html>