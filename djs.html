<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJs - KUAA 99.9 FM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header id="header-placeholder"></header>

    <main class="container" style="padding-top: 8rem;">
        <section id="djs" class="py-5">
            <h1 class="section-title text-center">Our DJs</h1>
            <div id="djs-container" class="row g-4 justify-content-center">
                <div class="col-12 text-center p-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer-placeholder" class="footer py-4"></footer>

    <script>
        // --- TEMPLATE LOADER ---
        async function loadTemplate(url, elementId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load template: ${url}`);
                const text = await response.text();
                document.getElementById(elementId).innerHTML = text;
            } catch (error) {
                console.error(error);
            }
        }

        async function initializePage() {
            await Promise.all([
                loadTemplate('_header.html', 'header-placeholder'),
                loadTemplate('_footer.html', 'footer-placeholder')
            ]);

            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('href').split('#')[0];
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            if (typeof initializeDjsPage === 'function') {
                initializeDjsPage();
            }
        }

        function initializeDjsPage() {
            const djsContainer = document.getElementById('djs-container');
            const djsApiUrl = `/.netlify/functions/get-djs`;

            const formatShowTime = (dateStr) => {
                const date = new Date(dateStr);
                const visitorTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const day = new Intl.DateTimeFormat('en-US', { weekday: 'long', timeZone: visitorTimeZone }).format(date);
                const time = new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: '2-digit', timeZone: visitorTimeZone }).format(date);
                return `${day} at ${time}`;
            };

            const fetchAndProcessDjs = async () => {
                try {
                    const response = await fetch(djsApiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const scheduleData = await response.json();

                    const shows = scheduleData.data || [];
                    const includedData = scheduleData.included || [];
                    const now = new Date();

                    const djsMap = new Map();

                    // Step 1: Populate the map with all unique DJs from the 'included' data
                    includedData.forEach(item => {
                        if (item.type === 'personas') {
                            djsMap.set(item.id, {
                                id: item.id,
                                name: item.attributes.name,
                                bio: item.attributes.bio,
                                image: item.attributes.image,
                                onAir: false,
                                nextShowTime: null
                            });
                        }
                    });

                    // Step 2: Iterate through shows to find the status and next air time for each DJ
                    shows.forEach(show => {
                        if (show.relationships.personas && show.relationships.personas.data.length > 0) {
                            show.relationships.personas.data.forEach(personaRef => {
                                const dj = djsMap.get(personaRef.id);
                                if (dj) {
                                    const startTime = new Date(show.attributes.start);
                                    const endTime = new Date(show.attributes.end);

                                    if (now >= startTime && now < endTime) {
                                        dj.onAir = true;
                                        dj.nextShowTime = startTime;
                                    } else if (startTime > now && (!dj.nextShowTime || startTime < dj.nextShowTime)) {
                                        dj.nextShowTime = startTime;
                                    }
                                }
                            });
                        }
                    });

                    // Step 3: Filter out DJs who don't have a show on the schedule
                    const activeDjs = Array.from(djsMap.values()).filter(dj => dj.nextShowTime !== null || dj.onAir);

                    // Step 4: Sort the active DJs
                    activeDjs.sort((a, b) => {
                        if (a.onAir) return -1;
                        if (b.onAir) return 1;
                        if (!a.nextShowTime) return 1;
                        if (!b.nextShowTime) return -1;
                        return new Date(a.nextShowTime) - new Date(b.nextShowTime);
                    });

                    renderDjs(activeDjs);

                } catch (error) {
                    console.error("Error fetching and processing DJs:", error);
                    djsContainer.innerHTML = '<p class="text-center p-3 text-danger">Could not load DJ information.</p>';
                }
            };

            const renderDjs = (djs) => {
                if (djs && djs.length > 0) {
                    let djsHtml = '';
                    djs.forEach(dj => {
                        let statusHtml = '';
                        if (dj.onAir) {
                            statusHtml = `<div class="card-footer bg-danger text-white fw-bold">ON AIR NOW</div>`;
                        } else if (dj.nextShowTime) {
                            statusHtml = `<div class="card-footer">Next up: ${formatShowTime(dj.nextShowTime)}</div>`;
                        }

                        djsHtml += `
                            <div class="col-md-6 col-lg-4 col-xl-3">
                                <div class="card h-100 text-center">
                                    <img src="${dj.image || 'https://placehold.co/400x400/A8DADC/1D3557?text=?'}" class="card-img-top" alt="${dj.name}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fw-bold">${dj.name}</h5>
                                        <p class="card-text small text-muted flex-grow-1">${dj.bio ? dj.bio.substring(0, 100) + '...' : ''}</p>
                                    </div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    });
                    djsContainer.innerHTML = djsHtml;
                } else {
                    djsContainer.innerHTML = '<p class="text-center p-3">Could not find any active DJs.</p>';
                }
            };

            fetchAndProcessDjs();
        }

        initializePage();
    </script>
</body>

</html>