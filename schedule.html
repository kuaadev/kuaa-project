<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - KUAA 99.9 FM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 2px;
            background-color: #dee2e6;
        }

        .schedule-header,
        .schedule-time,
        .schedule-slot {
            background-color: white;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .schedule-header {
            font-weight: bold;
            position: sticky;
            top: 70px;
            /* Adjust based on navbar height */
            z-index: 10;
        }

        .schedule-time {
            font-weight: bold;
            font-size: 0.8rem;
        }

        .schedule-slot {
            grid-row-start: var(--start-row);
            grid-row-end: var(--end-row);
            grid-column-start: var(--day-col);
            background-color: var(--kuaa-light);
            flex-direction: column;
            border-radius: 4px;
            font-size: 0.8rem;
            overflow: hidden;
            padding: 0.5rem;
        }

        .show-title {
            font-weight: bold;
            color: var(--kuaa-dark);
        }

        .dj-name {
            font-style: italic;
        }
    </style>
</head>

<body>
    <header id="header-placeholder"></header>

    <main class="container" style="padding-top: 8rem;">
        <section id="schedule-page" class="py-5">
            <h1 class="section-title text-center">Weekly Schedule</h1>
            <div id="schedule-container" class="bg-light p-3 rounded shadow">
                <div id="schedule-grid" class="schedule-grid">
                    <!-- Grid will be populated by JavaScript -->
                </div>
            </div>
        </section>
    </main>

    <footer id="footer-placeholder" class="footer py-4"></footer>

    <script>
        // --- TEMPLATE LOADER ---
        async function loadTemplate(url, elementId) { /* ... */ }

        async function initializePage() {
            await Promise.all([
                loadTemplate('_header.html', 'header-placeholder'),
                loadTemplate('_footer.html', 'footer-placeholder')
            ]);

            const currentPage = 'schedule.html';
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('href').split('#')[0];
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            if (typeof initializeSchedulePage === 'function') {
                initializeSchedulePage();
            }
        }

        function initializeSchedulePage() {
            const scheduleGrid = document.getElementById('schedule-grid');
            const scheduleApiUrl = `/.netlify/functions/get-schedule`;

            const fetchAndRenderSchedule = async () => {
                try {
                    const response = await fetch(scheduleApiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const scheduleData = await response.json();

                    renderGrid(scheduleData);

                } catch (error) {
                    console.error("Error fetching schedule:", error);
                    scheduleGrid.innerHTML = `<p class="text-center text-danger p-5">Could not load schedule.</p>`;
                }
            };

            const renderGrid = (scheduleData) => {
                const shows = scheduleData.data || [];
                const included = scheduleData.included || [];
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                let gridHtml = '<div class="schedule-header"></div>'; // Empty corner
                days.forEach(day => gridHtml += `<div class="schedule-header">${day}</div>`);

                // Create time slots from 12 AM to 11 PM
                for (let i = 0; i < 24; i++) {
                    const hour = i % 12 === 0 ? 12 : i % 12;
                    const ampm = i < 12 ? 'AM' : 'PM';
                    gridHtml += `<div class="schedule-time">${hour} ${ampm}</div>`;
                }

                shows.forEach(show => {
                    const start = new Date(show.attributes.start);
                    const end = new Date(show.attributes.end);
                    const visitorTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                    const startLocal = new Date(start.toLocaleString('en-US', { timeZone: visitorTimeZone }));
                    const endLocal = new Date(end.toLocaleString('en-US', { timeZone: visitorTimeZone }));

                    const startRow = startLocal.getHours() + 2; // +2 to account for header row
                    const endRow = endLocal.getHours() + 2;
                    const dayCol = startLocal.getDay() + 2; // +2 to account for time column

                    let djName = 'KUAA';
                    if (show.relationships.personas && show.relationships.personas.data.length > 0) {
                        const personaIds = show.relationships.personas.data.map(p => p.id);
                        djName = personaIds.map(id => {
                            const persona = included.find(inc => inc.type === 'personas' && inc.id === id);
                            return persona ? persona.attributes.name : '';
                        }).filter(Boolean).join(' & ');
                    }

                    gridHtml += `
                        <div class="schedule-slot" style="--start-row: ${startRow}; --end-row: ${endRow}; --day-col: ${dayCol};">
                            <div class="show-title">${show.attributes.title}</div>
                            <div class="dj-name">${djName}</div>
                        </div>
                    `;
                });

                scheduleGrid.innerHTML = gridHtml;
            };

            fetchAndRenderSchedule();
        }

        initializePage();
    </script>
</body>

</html>